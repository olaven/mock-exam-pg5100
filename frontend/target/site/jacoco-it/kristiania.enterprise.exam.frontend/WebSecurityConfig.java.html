<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">frontend</a> &gt; <a href="index.source.html" class="el_package">kristiania.enterprise.exam.frontend</a> &gt; <span class="el_source">WebSecurityConfig.java</span></div><h1>WebSecurityConfig.java</h1><pre class="source lang-java linenums">package kristiania.enterprise.exam.frontend;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;

import javax.sql.DataSource;

/*
* NOTE: This file is copied from:
* https://github.com/arcuri82/testing_security_development_enterprise_systems/blob/18f764c3123f60339ab98167790aa223641e7559/intro/spring/security/authorization/src/main/java/org/tsdes/intro/spring/security/authorization/WebSecurityConfig.java
*/

/**
 * Created by arcuri82 on 13-Dec-17.
 */
@Configuration
@EnableWebSecurity
<span class="fc" id="L27">public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span>

    @Autowired
    private DataSource dataSource;

    @Autowired
    private PasswordEncoder passwordEncoder;


    @Primary
    @Bean
    @Override
    public UserDetailsService userDetailsServiceBean() throws Exception {
<span class="fc" id="L40">        return super.userDetailsServiceBean();</span>
    }

    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception{
<span class="fc" id="L46">        return super.authenticationManagerBean();</span>
    }

    @Override
    protected void configure(HttpSecurity http) {
        try {
            /*
                Spring does the right thing, and activate CSRF protections.
                However, to avoid having to deal with them in JSF, and also
                because anyway we will see them in details in the &quot;advanced&quot;
                Enterprise 2 course, we just deactivate them
             */
<span class="fc" id="L58">            http.csrf().disable();</span>

<span class="fc" id="L60">            http.authorizeRequests()</span>
<span class="fc" id="L61">                    .antMatchers(&quot;/&quot;).permitAll()</span>
<span class="fc" id="L62">                    .antMatchers(&quot;/assets/**&quot;).permitAll()</span>
<span class="fc" id="L63">                    .antMatchers(&quot;/index.*&quot;).permitAll()</span>
<span class="fc" id="L64">                    .antMatchers(&quot;/signup.*&quot;).permitAll()</span>
<span class="fc" id="L65">                    .antMatchers(&quot;/javax.faces.resource/**&quot;).permitAll()</span>
<span class="fc" id="L66">                    .anyRequest().authenticated()</span>
<span class="fc" id="L67">                    .and()</span>
<span class="fc" id="L68">                    .formLogin()</span>
<span class="fc" id="L69">                    .loginPage(&quot;/login.jsf&quot;)</span>
<span class="fc" id="L70">                    .permitAll()</span>
<span class="fc" id="L71">                    .failureUrl(&quot;/login.jsf?error=true&quot;)</span>
<span class="fc" id="L72">                    .defaultSuccessUrl(&quot;/index.jsf?faces-redirect=true&quot;)</span>
<span class="fc" id="L73">                    .and()</span>
<span class="fc" id="L74">                    .logout()</span>
<span class="fc" id="L75">                    .logoutSuccessUrl(&quot;/index.jsf?faces-redirect=true&quot;);</span>
<span class="nc" id="L76">        } catch (Exception ex) {</span>
<span class="nc" id="L77">            throw new RuntimeException(ex);</span>
<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">    }</span>

    @Override
    protected void configure(AuthenticationManagerBuilder auth) {

        try {
<span class="fc" id="L85">            auth.jdbcAuthentication()</span>
<span class="fc" id="L86">                    .dataSource(dataSource)</span>
<span class="fc" id="L87">                    .usersByUsernameQuery(</span>
                            &quot;SELECT email, password, enabled &quot; +
                                    &quot;FROM user_entity &quot; +
                                    &quot;WHERE email = ?&quot;
                    )
<span class="fc" id="L92">                    .authoritiesByUsernameQuery(</span>
                            &quot;SELECT x.email, y.roles &quot; +
                                    &quot;FROM user_entity x, user_entity_roles y &quot; +
                                    &quot;WHERE x.email = ? and y.user_entity_email = x.email &quot;
                    )
                    /*
                        Note: in BCrypt, the &quot;password&quot; field also contains the salt
                     */
<span class="fc" id="L100">                    .passwordEncoder(passwordEncoder);</span>
<span class="nc" id="L101">        } catch (Exception e) {</span>
<span class="nc" id="L102">            throw new RuntimeException(e);</span>
<span class="fc" id="L103">        }</span>
<span class="fc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>